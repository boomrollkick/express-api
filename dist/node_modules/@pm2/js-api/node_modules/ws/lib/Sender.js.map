{"version":3,"sources":["../../../../../../../src/node_modules/@pm2/js-api/node_modules/ws/lib/Sender.js"],"names":["safeBuffer","require","crypto","PerMessageDeflate","bufferUtil","ErrorCodes","constants","Buffer","Sender","socket","extensions","_extensions","_socket","_firstFragment","_compress","_bufferedBytes","_deflating","_queue","code","data","mask","cb","buf","undefined","isValidErrorCode","Error","EMPTY_BUFFER","allocUnsafe","writeUInt16BE","byteLength","write","enqueue","doClose","sendFrame","frame","fin","rsv1","opcode","readOnly","isBuffer","ArrayBuffer","from","isView","viewToBuffer","doPing","doPong","options","binary","compress","perMessageDeflate","extensionName","length","_threshold","opts","dispatch","_","dequeue","params","shift","apply","slice","push","list","merge","offset","payloadLength","target","writeUInt32BE","copy","randomBytes","module","exports","view","buffer","byteOffset"],"mappings":"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","file":"Sender.js","sourcesContent":["/*!\n * ws: a node.js websocket client\n * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>\n * MIT Licensed\n */\n\n'use strict';\n\nconst safeBuffer = require('safe-buffer');\nconst crypto = require('crypto');\n\nconst PerMessageDeflate = require('./PerMessageDeflate');\nconst bufferUtil = require('./BufferUtil');\nconst ErrorCodes = require('./ErrorCodes');\nconst constants = require('./Constants');\n\nconst Buffer = safeBuffer.Buffer;\n\n/**\n * HyBi Sender implementation.\n */\nclass Sender {\n  /**\n   * Creates a Sender instance.\n   *\n   * @param {net.Socket} socket The connection socket\n   * @param {Object} extensions An object containing the negotiated extensions\n   */\n  constructor (socket, extensions) {\n    this._extensions = extensions || {};\n    this._socket = socket;\n\n    this._firstFragment = true;\n    this._compress = false;\n\n    this._bufferedBytes = 0;\n    this._deflating = false;\n    this._queue = [];\n  }\n\n  /**\n   * Frames a piece of data according to the HyBi WebSocket protocol.\n   *\n   * @param {Buffer} data The data to frame\n   * @param {Object} options Options object\n   * @param {Number} options.opcode The opcode\n   * @param {Boolean} options.readOnly Specifies whether `data` can be modified\n   * @param {Boolean} options.fin Specifies whether or not to set the FIN bit\n   * @param {Boolean} options.mask Specifies whether or not to mask `data`\n   * @param {Boolean} options.rsv1 Specifies whether or not to set the RSV1 bit\n   * @return {Buffer[]} The framed data as a list of `Buffer` instances\n   * @public\n   */\n  static frame (data, options) {\n    const merge = data.length < 1024 || (options.mask && options.readOnly);\n    var offset = options.mask ? 6 : 2;\n    var payloadLength = data.length;\n\n    if (data.length >= 65536) {\n      offset += 8;\n      payloadLength = 127;\n    } else if (data.length > 125) {\n      offset += 2;\n      payloadLength = 126;\n    }\n\n    const target = Buffer.allocUnsafe(merge ? data.length + offset : offset);\n\n    target[0] = options.fin ? options.opcode | 0x80 : options.opcode;\n    if (options.rsv1) target[0] |= 0x40;\n\n    if (payloadLength === 126) {\n      target.writeUInt16BE(data.length, 2, true);\n    } else if (payloadLength === 127) {\n      target.writeUInt32BE(0, 2, true);\n      target.writeUInt32BE(data.length, 6, true);\n    }\n\n    if (!options.mask) {\n      target[1] = payloadLength;\n      if (merge) {\n        data.copy(target, offset);\n        return [target];\n      }\n\n      return [target, data];\n    }\n\n    const mask = crypto.randomBytes(4);\n\n    target[1] = payloadLength | 0x80;\n    target[offset - 4] = mask[0];\n    target[offset - 3] = mask[1];\n    target[offset - 2] = mask[2];\n    target[offset - 1] = mask[3];\n\n    if (merge) {\n      bufferUtil.mask(data, mask, target, offset, data.length);\n      return [target];\n    }\n\n    bufferUtil.mask(data, mask, data, 0, data.length);\n    return [target, data];\n  }\n\n  /**\n   * Sends a close message to the other peer.\n   *\n   * @param {(Number|undefined)} code The status code component of the body\n   * @param {String} data The message component of the body\n   * @param {Boolean} mask Specifies whether or not to mask the message\n   * @param {Function} cb Callback\n   * @public\n   */\n  close (code, data, mask, cb) {\n    var buf;\n\n    if (code === undefined) {\n      code = 1000;\n    } else if (typeof code !== 'number' || !ErrorCodes.isValidErrorCode(code)) {\n      throw new Error('first argument must be a valid error code number');\n    }\n\n    if (data === undefined || data === '') {\n      if (code === 1000) {\n        buf = constants.EMPTY_BUFFER;\n      } else {\n        buf = Buffer.allocUnsafe(2);\n        buf.writeUInt16BE(code, 0, true);\n      }\n    } else {\n      buf = Buffer.allocUnsafe(2 + Buffer.byteLength(data));\n      buf.writeUInt16BE(code, 0, true);\n      buf.write(data, 2);\n    }\n\n    if (this._deflating) {\n      this.enqueue([this.doClose, buf, mask, cb]);\n    } else {\n      this.doClose(buf, mask, cb);\n    }\n  }\n\n  /**\n   * Frames and sends a close message.\n   *\n   * @param {Buffer} data The message to send\n   * @param {Boolean} mask Specifies whether or not to mask `data`\n   * @param {Function} cb Callback\n   * @private\n   */\n  doClose (data, mask, cb) {\n    this.sendFrame(Sender.frame(data, {\n      fin: true,\n      rsv1: false,\n      opcode: 0x08,\n      mask,\n      readOnly: false\n    }), cb);\n  }\n\n  /**\n   * Sends a ping message to the other peer.\n   *\n   * @param {*} data The message to send\n   * @param {Boolean} mask Specifies whether or not to mask `data`\n   * @public\n   */\n  ping (data, mask) {\n    var readOnly = true;\n\n    if (!Buffer.isBuffer(data)) {\n      if (data instanceof ArrayBuffer) {\n        data = Buffer.from(data);\n      } else if (ArrayBuffer.isView(data)) {\n        data = viewToBuffer(data);\n      } else {\n        data = Buffer.from(data);\n        readOnly = false;\n      }\n    }\n\n    if (this._deflating) {\n      this.enqueue([this.doPing, data, mask, readOnly]);\n    } else {\n      this.doPing(data, mask, readOnly);\n    }\n  }\n\n  /**\n   * Frames and sends a ping message.\n   *\n   * @param {*} data The message to send\n   * @param {Boolean} mask Specifies whether or not to mask `data`\n   * @param {Boolean} readOnly Specifies whether `data` can be modified\n   * @private\n   */\n  doPing (data, mask, readOnly) {\n    this.sendFrame(Sender.frame(data, {\n      fin: true,\n      rsv1: false,\n      opcode: 0x09,\n      mask,\n      readOnly\n    }));\n  }\n\n  /**\n   * Sends a pong message to the other peer.\n   *\n   * @param {*} data The message to send\n   * @param {Boolean} mask Specifies whether or not to mask `data`\n   * @public\n   */\n  pong (data, mask) {\n    var readOnly = true;\n\n    if (!Buffer.isBuffer(data)) {\n      if (data instanceof ArrayBuffer) {\n        data = Buffer.from(data);\n      } else if (ArrayBuffer.isView(data)) {\n        data = viewToBuffer(data);\n      } else {\n        data = Buffer.from(data);\n        readOnly = false;\n      }\n    }\n\n    if (this._deflating) {\n      this.enqueue([this.doPong, data, mask, readOnly]);\n    } else {\n      this.doPong(data, mask, readOnly);\n    }\n  }\n\n  /**\n   * Frames and sends a pong message.\n   *\n   * @param {*} data The message to send\n   * @param {Boolean} mask Specifies whether or not to mask `data`\n   * @param {Boolean} readOnly Specifies whether `data` can be modified\n   * @private\n   */\n  doPong (data, mask, readOnly) {\n    this.sendFrame(Sender.frame(data, {\n      fin: true,\n      rsv1: false,\n      opcode: 0x0a,\n      mask,\n      readOnly\n    }));\n  }\n\n  /**\n   * Sends a data message to the other peer.\n   *\n   * @param {*} data The message to send\n   * @param {Object} options Options object\n   * @param {Boolean} options.compress Specifies whether or not to compress `data`\n   * @param {Boolean} options.binary Specifies whether `data` is binary or text\n   * @param {Boolean} options.fin Specifies whether the fragment is the last one\n   * @param {Boolean} options.mask Specifies whether or not to mask `data`\n   * @param {Function} cb Callback\n   * @public\n   */\n  send (data, options, cb) {\n    var opcode = options.binary ? 2 : 1;\n    var rsv1 = options.compress;\n    var readOnly = true;\n\n    if (!Buffer.isBuffer(data)) {\n      if (data instanceof ArrayBuffer) {\n        data = Buffer.from(data);\n      } else if (ArrayBuffer.isView(data)) {\n        data = viewToBuffer(data);\n      } else {\n        data = Buffer.from(data);\n        readOnly = false;\n      }\n    }\n\n    const perMessageDeflate = this._extensions[PerMessageDeflate.extensionName];\n\n    if (this._firstFragment) {\n      this._firstFragment = false;\n      if (rsv1 && perMessageDeflate) {\n        rsv1 = data.length >= perMessageDeflate._threshold;\n      }\n      this._compress = rsv1;\n    } else {\n      rsv1 = false;\n      opcode = 0;\n    }\n\n    if (options.fin) this._firstFragment = true;\n\n    if (perMessageDeflate) {\n      const opts = {\n        fin: options.fin,\n        rsv1,\n        opcode,\n        mask: options.mask,\n        readOnly\n      };\n\n      if (this._deflating) {\n        this.enqueue([this.dispatch, data, this._compress, opts, cb]);\n      } else {\n        this.dispatch(data, this._compress, opts, cb);\n      }\n    } else {\n      this.sendFrame(Sender.frame(data, {\n        fin: options.fin,\n        rsv1: false,\n        opcode,\n        mask: options.mask,\n        readOnly\n      }), cb);\n    }\n  }\n\n  /**\n   * Dispatches a data message.\n   *\n   * @param {Buffer} data The message to send\n   * @param {Boolean} compress Specifies whether or not to compress `data`\n   * @param {Object} options Options object\n   * @param {Number} options.opcode The opcode\n   * @param {Boolean} options.readOnly Specifies whether `data` can be modified\n   * @param {Boolean} options.fin Specifies whether or not to set the FIN bit\n   * @param {Boolean} options.mask Specifies whether or not to mask `data`\n   * @param {Boolean} options.rsv1 Specifies whether or not to set the RSV1 bit\n   * @param {Function} cb Callback\n   * @private\n   */\n  dispatch (data, compress, options, cb) {\n    if (!compress) {\n      this.sendFrame(Sender.frame(data, options), cb);\n      return;\n    }\n\n    const perMessageDeflate = this._extensions[PerMessageDeflate.extensionName];\n\n    this._deflating = true;\n    perMessageDeflate.compress(data, options.fin, (_, buf) => {\n      options.readOnly = false;\n      this.sendFrame(Sender.frame(buf, options), cb);\n      this._deflating = false;\n      this.dequeue();\n    });\n  }\n\n  /**\n   * Executes queued send operations.\n   *\n   * @private\n   */\n  dequeue () {\n    while (!this._deflating && this._queue.length) {\n      const params = this._queue.shift();\n\n      this._bufferedBytes -= params[1].length;\n      params[0].apply(this, params.slice(1));\n    }\n  }\n\n  /**\n   * Enqueues a send operation.\n   *\n   * @param {Array} params Send operation parameters.\n   * @private\n   */\n  enqueue (params) {\n    this._bufferedBytes += params[1].length;\n    this._queue.push(params);\n  }\n\n  /**\n   * Sends a frame.\n   *\n   * @param {Buffer[]} list The frame to send\n   * @param {Function} cb Callback\n   * @private\n   */\n  sendFrame (list, cb) {\n    if (list.length === 2) {\n      this._socket.write(list[0]);\n      this._socket.write(list[1], cb);\n    } else {\n      this._socket.write(list[0], cb);\n    }\n  }\n}\n\nmodule.exports = Sender;\n\n/**\n * Converts an `ArrayBuffer` view into a buffer.\n *\n * @param {(DataView|TypedArray)} view The view to convert\n * @return {Buffer} Converted view\n * @private\n */\nfunction viewToBuffer (view) {\n  const buf = Buffer.from(view.buffer);\n\n  if (view.byteLength !== view.buffer.byteLength) {\n    return buf.slice(view.byteOffset, view.byteOffset + view.byteLength);\n  }\n\n  return buf;\n}\n"]}