{"version":3,"sources":["../../../../../../src/node_modules/@pm2/js-api/src/utils/websocket.js"],"names":["ws","require","debug","_WebSocket","WebSocket","defaultOptions","automaticOpen","reconnectOnError","reconnectInterval","maxReconnectInterval","reconnectDecay","timeoutInterval","maxReconnectAttempts","Infinity","randomRatio","reconnectOnCleanClose","ReconnectableWebSocket","url","token","protocols","options","CONNECTING","OPEN","CLOSING","CLOSED","_url","_token","_protocols","_options","Object","assign","_messageQueue","_reconnectAttempts","readyState","_debug","console","log","bind","open","prototype","updateAuthorization","authorization","socket","_socket","binaryType","onmaxreconnect","_syncState","on","_onunexpectedresponse","onmessage","_onmessage","onopen","_onopen","onclose","_onclose","onerror","_onerror","send","data","length","push","ping","close","code","reason","req","res","onunexpectedresponse","message","event","_flushQueue","onreconnect","_tryReconnect","self","wasClean","setTimeout","_getTimeout","shift","timeout","Math","pow","getRandom","min","max","random","module","exports"],"mappings":"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","file":"websocket.js","sourcesContent":["/* global WebSocket */\n\n'use strict'\n\nconst ws = require('ws')\nconst debug = require('debug')('kmjs:network:_ws')\n\nconst _WebSocket = typeof ws !== 'function' ? WebSocket : ws\n\nconst defaultOptions = {\n  debug: false,\n  automaticOpen: true,\n  reconnectOnError: true,\n  reconnectInterval: 1000,\n  maxReconnectInterval: 10000,\n  reconnectDecay: 1,\n  timeoutInterval: 2000,\n  maxReconnectAttempts: Infinity,\n  randomRatio: 3,\n  reconnectOnCleanClose: false\n}\n\nconst ReconnectableWebSocket = function (url, token, protocols, options) {\n  if (!protocols) protocols = []\n  if (!options) options = []\n\n  this.CONNECTING = 0\n  this.OPEN = 1\n  this.CLOSING = 2\n  this.CLOSED = 3\n\n  this._url = url\n  this._token = token\n  this._protocols = protocols\n  this._options = Object.assign({}, defaultOptions, options)\n  this._messageQueue = []\n  this._reconnectAttempts = 0\n  this.readyState = this.CONNECTING\n\n  if (typeof this._options.debug === 'function') {\n    this._debug = this._options.debug\n  } else if (this._options.debug) {\n    this._debug = console.log.bind(console)\n  } else {\n    this._debug = function () {}\n  }\n\n  if (this._options.automaticOpen) this.open()\n}\n\nReconnectableWebSocket.prototype.updateAuthorization = function (authorization) {\n  this._token = authorization\n}\n\nReconnectableWebSocket.prototype.open = function () {\n  debug('open')\n  var socket = this._socket = new _WebSocket(`${this._url}?token=${this._token}`, this._protocols)\n\n  if (this._options.binaryType) {\n    socket.binaryType = this._options.binaryType\n  }\n\n  if (this._options.maxReconnectAttempts && this._options.maxReconnectAttempts < this._reconnectAttempts) {\n    return this.onmaxreconnect()\n  }\n\n  this._syncState()\n\n  if (socket.on) {\n    socket.on('unexpected-response', this._onunexpectedresponse)\n  }\n  socket.onmessage = this._onmessage.bind(this)\n  socket.onopen = this._onopen.bind(this)\n  socket.onclose = this._onclose.bind(this)\n  socket.onerror = this._onerror.bind(this)\n}\n\nReconnectableWebSocket.prototype.send = function (data) {\n  debug('send')\n  if (this._socket && this._socket.readyState === _WebSocket.OPEN && this._messageQueue.length === 0) {\n    this._socket.send(data)\n  } else {\n    this._messageQueue.push(data)\n  }\n}\n\nReconnectableWebSocket.prototype.ping = function () {\n  debug('ping')\n  if (this._socket.ping && this._socket && this._socket.readyState === _WebSocket.OPEN && this._messageQueue.length === 0) {\n    this._socket.ping()\n  }\n}\n\nReconnectableWebSocket.prototype.close = function (code, reason) {\n  debug('close')\n  if (typeof code === 'undefined') code = 1000\n\n  if (this._socket) this._socket.close(code, reason)\n}\n\nReconnectableWebSocket.prototype._onunexpectedresponse = function (req, res) {\n  debug('unexpected-response')\n  this.onunexpectedresponse && this.onunexpectedresponse(req, res)\n}\n\nReconnectableWebSocket.prototype._onmessage = function (message) {\n  debug('onmessage')\n  this.onmessage && this.onmessage(message)\n}\n\nReconnectableWebSocket.prototype._onopen = function (event) {\n  debug('onopen')\n  this._syncState()\n  this._flushQueue()\n  if (this._reconnectAttempts !== 0) {\n    this.onreconnect && this.onreconnect()\n  }\n  this._reconnectAttempts = 0\n\n  this.onopen && this.onopen(event)\n}\n\nReconnectableWebSocket.prototype._onclose = function (event) {\n  debug('onclose', event)\n  this._syncState()\n  this._debug('WebSocket: connection is broken', event)\n\n  this.onclose && this.onclose(event)\n\n  this._tryReconnect(event)\n}\n\nReconnectableWebSocket.prototype._onerror = function (event) {\n  debug('onerror', event)\n  // To avoid undetermined state, we close socket on error\n  this._socket.close()\n  this._syncState()\n\n  this._debug('WebSocket: error', event)\n\n  this.onerror && this.onerror(event)\n\n  if (this._options.reconnectOnError) this._tryReconnect(event)\n}\n\nReconnectableWebSocket.prototype._tryReconnect = function (event) {\n  var self = this\n  debug('Trying to reconnect')\n  if (event.wasClean && !this._options.reconnectOnCleanClose) {\n    return\n  }\n  setTimeout(function () {\n    if (self.readyState === self.CLOSING || self.readyState === self.CLOSED) {\n      self._reconnectAttempts++\n      self.open()\n    }\n  }, this._getTimeout())\n}\n\nReconnectableWebSocket.prototype._flushQueue = function () {\n  while (this._messageQueue.length !== 0) {\n    var data = this._messageQueue.shift()\n    this._socket.send(data)\n  }\n}\n\nReconnectableWebSocket.prototype._getTimeout = function () {\n  var timeout = this._options.reconnectInterval * Math.pow(this._options.reconnectDecay, this._reconnectAttempts)\n  timeout = timeout > this._options.maxReconnectInterval ? this._options.maxReconnectInterval : timeout\n  return this._options.randomRatio ? getRandom(timeout / this._options.randomRatio, timeout) : timeout\n}\n\nReconnectableWebSocket.prototype._syncState = function () {\n  this.readyState = this._socket.readyState\n}\n\nfunction getRandom (min, max) {\n  return Math.random() * (max - min) + min\n}\n\nmodule.exports = ReconnectableWebSocket\n"]}