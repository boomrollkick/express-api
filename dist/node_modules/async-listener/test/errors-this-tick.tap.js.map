{"version":3,"sources":["../../../../src/node_modules/async-listener/test/errors-this-tick.tap.js"],"names":["assert","require","process","addAsyncListener","MiniCLS","active","Object","create","_stack","prototype","enter","context","ok","push","exit","length","pop","index","lastIndexOf","run","fn","cls","before","domain","after","error","on","err","message","console","log","stack","Error"],"mappings":"AAAA;;AAEA,IAAIA,SAASC,QAAQ,QAAR,CAAb;;AAEA,IAAI,CAACC,QAAQC,gBAAb,EAA+BF,QAAQ,aAAR;;AAE/B,SAASG,OAAT,GAAmB;AACjB,OAAKC,MAAL,GAAcC,OAAOC,MAAP,CAAc,IAAd,CAAd;AACA,OAAKC,MAAL,GAAc,EAAd;AACD;;AAEDJ,QAAQK,SAAR,CAAkBC,KAAlB,GAA0B,UAAUC,OAAV,EAAmB;AAC3CX,SAAOY,EAAP,CAAUD,OAAV,EAAmB,uCAAnB;;AAEA,OAAKH,MAAL,CAAYK,IAAZ,CAAiB,KAAKR,MAAtB;AACA,OAAKA,MAAL,GAAcM,OAAd;AACD,CALD;;AAOAP,QAAQK,SAAR,CAAkBK,IAAlB,GAAyB,UAAUH,OAAV,EAAmB;AAC1CX,SAAOY,EAAP,CAAUD,OAAV,EAAmB,sCAAnB;;AAEA,MAAI,KAAKN,MAAL,KAAgBM,OAApB,EAA6B;AAC3BX,WAAOY,EAAP,CAAU,KAAKJ,MAAL,CAAYO,MAAtB,EAA8B,0BAA9B;AACA,SAAKV,MAAL,GAAc,KAAKG,MAAL,CAAYQ,GAAZ,EAAd;AACA;AACD;;AAED,MAAIC,QAAQ,KAAKT,MAAL,CAAYU,WAAZ,CAAwBP,OAAxB,CAAZ;;AAEAX,SAAOY,EAAP,CAAUK,SAAS,CAAnB,EAAsB,2CAAtB;AACAjB,SAAOY,EAAP,CAAUK,KAAV,EAAsB,0BAAtB;;AAEA,OAAKZ,MAAL,GAAc,KAAKG,MAAL,CAAYS,QAAQ,CAApB,CAAd;AACA,OAAKT,MAAL,CAAYO,MAAZ,GAAqBE,QAAQ,CAA7B;AACD,CAhBD;;AAkBAb,QAAQK,SAAR,CAAkBU,GAAlB,GAAwB,UAAUC,EAAV,EAAc;AACpC,MAAIT,UAAUL,OAAOC,MAAP,CAAc,KAAKF,MAAnB,CAAd;AACA,OAAKK,KAAL,CAAWC,OAAX;AACA,MAAI;AACFS,OAAGT,OAAH;AACA,WAAOA,OAAP;AACD,GAHD,SAIQ;AACN,SAAKG,IAAL,CAAUH,OAAV;AACD;AACF,CAVD;;AAYA,IAAIU,MAAM,IAAIjB,OAAJ,EAAV;AACAF,QAAQC,gBAAR,CACE;AACEI,UAAS,kBAAY;AAAE,WAAOc,IAAIhB,MAAX;AAAoB,GAD7C;AAEEiB,UAAS,gBAAUX,OAAV,EAAmBY,MAAnB,EAA2B;AAAEF,QAAIX,KAAJ,CAAUa,MAAV;AAAoB,GAF5D;AAGEC,SAAS,eAAUb,OAAV,EAAmBY,MAAnB,EAA2B;AAAEF,QAAIP,IAAJ,CAASS,MAAT;AAAmB,GAH3D;AAIEE,SAAS,eAAUF,MAAV,EAAkB;AAAE,QAAIA,MAAJ,EAAYF,IAAIP,IAAJ,CAASS,MAAT;AAAmB;AAJ9D,CADF;;AASArB,QAAQwB,EAAR,CAAW,mBAAX,EAAgC,UAAUC,GAAV,EAAe;AAC7C,MAAIA,IAAIC,OAAJ,KAAgB,MAApB,EAA4B;AAC1BC,YAAQC,GAAR,CAAY,2BAAZ,EAAyCH,IAAIC,OAA7C;AACD,GAFD,MAGK;AACHC,YAAQC,GAAR,CAAY,+BAAZ,EAA6CH,IAAII,KAAjD;AACD;AACF,CAPD;;AASAV,IAAIF,GAAJ,CAAQ,YAAY;AAClB,QAAM,IAAIa,KAAJ,CAAU,MAAV,CAAN;AACD,CAFD","file":"errors-this-tick.tap.js","sourcesContent":["'use strict';\n\nvar assert = require('assert');\n\nif (!process.addAsyncListener) require('../index.js');\n\nfunction MiniCLS() {\n  this.active = Object.create(null);\n  this._stack = [];\n}\n\nMiniCLS.prototype.enter = function (context) {\n  assert.ok(context, \"context must be provided for entering\");\n\n  this._stack.push(this.active);\n  this.active = context;\n};\n\nMiniCLS.prototype.exit = function (context) {\n  assert.ok(context, \"context must be provided for exiting\");\n\n  if (this.active === context) {\n    assert.ok(this._stack.length, \"can't remove top context\");\n    this.active = this._stack.pop();\n    return;\n  }\n\n  var index = this._stack.lastIndexOf(context);\n\n  assert.ok(index >= 0, \"context not currently entered; can't exit\");\n  assert.ok(index,      \"can't remove top context\");\n\n  this.active = this._stack[index - 1];\n  this._stack.length = index - 1;\n};\n\nMiniCLS.prototype.run = function (fn) {\n  var context = Object.create(this.active);\n  this.enter(context);\n  try {\n    fn(context);\n    return context;\n  }\n  finally {\n    this.exit(context);\n  }\n};\n\nvar cls = new MiniCLS();\nprocess.addAsyncListener(\n  {\n    create : function () { return cls.active; },\n    before : function (context, domain) { cls.enter(domain); },\n    after  : function (context, domain) { cls.exit(domain); },\n    error  : function (domain) { if (domain) cls.exit(domain); }\n  }\n);\n\nprocess.on('uncaughtException', function (err) {\n  if (err.message === 'oops') {\n    console.log('ok got expected error: %s', err.message);\n  }\n  else {\n    console.log('not ok got expected error: %s', err.stack);\n  }\n});\n\ncls.run(function () {\n  throw new Error('oops');\n});\n"]}