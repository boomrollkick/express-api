{"version":3,"sources":["../../../../src/node_modules/async-listener/test/core-asynclistener.simple.js"],"names":["PORT","process","addAsyncListener","require","global","setImmediate","setTimeout","assert","net","fs","dgram","addListener","removeListener","removeAsyncListener","actualAsync","expectAsync","callbacks","create","onAsync","listener","createAsyncListener","on","console","log","ok","nextTick","b","setInterval","clearInterval","c","interval","i","stat","err","server","createServer","listen","close","createSocket","bind"],"mappings":"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","file":"core-asynclistener.simple.js","sourcesContent":["// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\nvar PORT = 12346;\n\nif (!process.addAsyncListener) require('../index.js');\nif (!global.setImmediate) global.setImmediate = setTimeout;\n\nvar assert = require('assert');\nvar net = require('net');\nvar fs = require('fs');\nvar dgram = require('dgram');\n\nvar addListener = process.addAsyncListener;\nvar removeListener = process.removeAsyncListener;\nvar actualAsync = 0;\nvar expectAsync = 0;\n\nvar callbacks = {\n  create: function onAsync() {\n    actualAsync++;\n  }\n};\n\nvar listener = process.createAsyncListener(callbacks);\n\nprocess.on('exit', function() {\n  console.log('expected', expectAsync);\n  console.log('actual  ', actualAsync);\n  // TODO(trevnorris): Not a great test. If one was missed, but others\n  // overflowed then the test would still pass.\n  assert.ok(actualAsync >= expectAsync);\n});\n\n\n// Test listeners side-by-side\nprocess.nextTick(function() {\n  addListener(listener);\n\n  var b = setInterval(function() {\n    clearInterval(b);\n  });\n  expectAsync++;\n\n  var c = setInterval(function() {\n    clearInterval(c);\n  });\n  expectAsync++;\n\n  setTimeout(function() { });\n  expectAsync++;\n\n  setTimeout(function() { });\n  expectAsync++;\n\n  process.nextTick(function() { });\n  expectAsync++;\n\n  process.nextTick(function() { });\n  expectAsync++;\n\n  setImmediate(function() { });\n  expectAsync++;\n\n  setImmediate(function() { });\n  expectAsync++;\n\n  setTimeout(function() { }, 10);\n  expectAsync++;\n\n  setTimeout(function() { }, 10);\n  expectAsync++;\n\n  removeListener(listener);\n});\n\n\n// Async listeners should propagate with nested callbacks\nprocess.nextTick(function() {\n  addListener(listener);\n  var interval = 3;\n\n  process.nextTick(function() {\n    setTimeout(function() {\n      setImmediate(function() {\n        var i = setInterval(function() {\n          if (--interval <= 0)\n            clearInterval(i);\n        });\n        expectAsync++;\n      });\n      expectAsync++;\n      process.nextTick(function() {\n        setImmediate(function() {\n          setTimeout(function() { }, 20);\n          expectAsync++;\n        });\n        expectAsync++;\n      });\n      expectAsync++;\n    });\n    expectAsync++;\n  });\n  expectAsync++;\n\n  removeListener(listener);\n});\n\n\n// Test triggers with two async listeners\nprocess.nextTick(function() {\n  addListener(listener);\n  addListener(listener);\n\n  setTimeout(function() {\n    process.nextTick(function() { });\n    expectAsync += 2;\n  });\n  expectAsync += 2;\n\n  removeListener(listener);\n  removeListener(listener);\n});\n\n\n// Test callbacks from fs I/O\nprocess.nextTick(function() {\n  addListener(listener);\n\n  fs.stat('something random', function(err, stat) { });\n  expectAsync++;\n\n  setImmediate(function() {\n    fs.stat('random again', function(err, stat) { });\n    expectAsync++;\n  });\n  expectAsync++;\n\n  removeListener(listener);\n});\n\n\n// Test net I/O\nprocess.nextTick(function() {\n  addListener(listener);\n\n  var server = net.createServer(function(c) { });\n  expectAsync++;\n\n  server.listen(PORT, function() {\n    server.close();\n    expectAsync++;\n  });\n  expectAsync++;\n\n  removeListener(listener);\n});\n\n\n// Test UDP\nprocess.nextTick(function() {\n  addListener(listener);\n\n  var server = dgram.createSocket('udp4');\n  expectAsync++;\n\n  server.bind(PORT);\n\n  server.close();\n  expectAsync++;\n\n  removeListener(listener);\n});\n"]}