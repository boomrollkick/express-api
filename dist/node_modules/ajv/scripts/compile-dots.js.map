{"version":3,"sources":["../../../../src/node_modules/ajv/scripts/compile-dots.js"],"names":["glob","require","fs","path","doT","beautify","js_beautify","defsRootPath","process","argv","join","__dirname","defs","defFiles","sync","cwd","forEach","f","name","basename","readFileSync","filesRootPath","files","dotjsPath","mkdirSync","e","console","log","FUNCTION_NAME","OUT_EMPTY_STRING","ISTANBUL","ERROR_KEYWORD","ERROR_KEYWORD_OR","VARS","keyword","targetPath","template","code","compile","toString","replace","removeAlwaysFalsyInOr","removeUnusedVar","indent_size","writeFileSync","v","regexp","RegExp","count","occurrences","countUsed","countOr","match","length"],"mappings":"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","file":"compile-dots.js","sourcesContent":["//compile doT templates to js functions\n'use strict';\n\nvar glob = require('glob')\n  , fs = require('fs')\n  , path = require('path')\n  , doT = require('dot')\n  , beautify = require('js-beautify').js_beautify;\n\nvar defsRootPath = process.argv[2] || path.join(__dirname, '../lib');\n\nvar defs = {};\nvar defFiles = glob.sync('./dot/**/*.def', { cwd: defsRootPath });\ndefFiles.forEach(function (f) {\n  var name = path.basename(f, '.def');\n  defs[name] = fs.readFileSync(path.join(defsRootPath, f));\n});\n\nvar filesRootPath = process.argv[3] || path.join(__dirname, '../lib');\nvar files = glob.sync('./dot/**/*.jst', { cwd: filesRootPath });\n\nvar dotjsPath = path.join(filesRootPath, './dotjs');\ntry { fs.mkdirSync(dotjsPath); } catch(e) {}\n\nconsole.log('\\n\\nCompiling:');\n\nvar FUNCTION_NAME = /function\\s+anonymous\\s*\\(it[^)]*\\)\\s*{/;\nvar OUT_EMPTY_STRING = /out\\s*\\+=\\s*'\\s*';/g;\nvar ISTANBUL = /\\'(istanbul[^']+)\\';/g;\nvar ERROR_KEYWORD = /\\$errorKeyword/g;\nvar ERROR_KEYWORD_OR = /\\$errorKeyword\\s+\\|\\|/g;\nvar VARS = [\n  '$errs', '$valid', '$lvl', '$data', '$dataLvl',\n  '$errorKeyword', '$closingBraces', '$schemaPath',\n  '$validate'\n];\n\nfiles.forEach(function (f) {\n  var keyword = path.basename(f, '.jst');\n  var targetPath = path.join(dotjsPath, keyword + '.js');\n  var template = fs.readFileSync(path.join(filesRootPath, f));\n  var code = doT.compile(template, defs);\n  code = code.toString()\n             .replace(OUT_EMPTY_STRING, '')\n             .replace(FUNCTION_NAME, 'function generate_' + keyword + '(it, $keyword) {')\n             .replace(ISTANBUL, '/* $1 */');\n  removeAlwaysFalsyInOr();\n  VARS.forEach(removeUnusedVar);\n  code = \"'use strict';\\nmodule.exports = \" + code;\n  code = beautify(code, { indent_size: 2 }) + '\\n';\n  fs.writeFileSync(targetPath, code);\n  console.log('compiled', keyword);\n\n  function removeUnusedVar(v) {\n    v = v.replace(/\\$/g, '\\\\$$');\n    var regexp = new RegExp(v + '[^A-Za-z0-9_$]', 'g');\n    var count = occurrences(regexp);\n    if (count == 1) {\n      regexp = new RegExp('var\\\\s+' + v + '\\\\s*=[^;]+;|var\\\\s+' + v + ';');\n      code = code.replace(regexp, '');\n    }\n  }\n\n  function removeAlwaysFalsyInOr() {\n    var countUsed = occurrences(ERROR_KEYWORD);\n    var countOr = occurrences(ERROR_KEYWORD_OR);\n    if (countUsed == countOr + 1) code = code.replace(ERROR_KEYWORD_OR, '');\n  }\n\n  function occurrences(regexp) {\n    return (code.match(regexp) || []).length;\n  }\n});\n"]}