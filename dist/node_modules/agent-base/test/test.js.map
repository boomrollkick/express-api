{"version":3,"sources":["../../../../src/node_modules/agent-base/test/test.js"],"names":["fs","require","url","net","tls","http","https","WebSocket","assert","events","inherits","Agent","PassthroughAgent","req","opts","secureEndpoint","globalAgent","describe","it","done","MyAgent","call","prototype","callback","fn","equal","path","getHeader","info","parse","agent","get","timeout","host","port","foo","b","called","on","err","test","message","Error","setTimeout","stream","EventEmitter","writable","write","str","indexOf","cork","method","request","end","res","httpVersion","statusCode","headers","once","buf","Buffer","emit","server","before","createServer","listen","address","after","close","socket","connect","gotReq","setHeader","Promise","resolve","reject","connection","slow","code","abort","destroyed","options","key","readFileSync","__dirname","cert","endpoint","rejectUnauthorized","wss","Server","onconnection","ws","data","send","client","removeListener"],"mappings":"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","file":"test.js","sourcesContent":["/**\n * Module dependencies.\n */\n\nvar fs = require('fs');\nvar url = require('url');\nvar net = require('net');\nvar tls = require('tls');\nvar http = require('http');\nvar https = require('https');\nvar WebSocket = require('ws');\nvar assert = require('assert');\nvar events = require('events');\nvar inherits = require('util').inherits;\nvar Agent = require('../');\n\nvar PassthroughAgent = Agent(function(req, opts) {\n  return opts.secureEndpoint ? https.globalAgent : http.globalAgent;\n});\n\ndescribe('Agent', function() {\n  describe('subclass', function() {\n    it('should be subclassable', function(done) {\n      function MyAgent() {\n        Agent.call(this);\n      }\n      inherits(MyAgent, Agent);\n\n      MyAgent.prototype.callback = function(req, opts, fn) {\n        assert.equal(req.path, '/foo');\n        assert.equal(req.getHeader('host'), '127.0.0.1:1234');\n        assert.equal(opts.secureEndpoint, true);\n        done();\n      };\n\n      var info = url.parse('https://127.0.0.1:1234/foo');\n      info.agent = new MyAgent();\n      https.get(info);\n    });\n  });\n  describe('options', function() {\n    it('should support an options Object as first argument', function() {\n      var agent = new Agent({ timeout: 1000 });\n      assert.equal(1000, agent.timeout);\n    });\n    it('should support an options Object as second argument', function() {\n      var agent = new Agent(function() {}, { timeout: 1000 });\n      assert.equal(1000, agent.timeout);\n    });\n    it('should be mixed in with HTTP request options', function(done) {\n      var agent = new Agent({\n        host: 'my-proxy.com',\n        port: 3128,\n        foo: 'bar'\n      });\n      agent.callback = function(req, opts, fn) {\n        assert.equal('bar', opts.foo);\n        assert.equal('a', opts.b);\n\n        // `host` and `port` are special-cases, and should always be\n        // overwritten in the request `opts` inside the agent-base callback\n        assert.equal('localhost', opts.host);\n        assert.equal(80, opts.port);\n        done();\n      };\n      var opts = {\n        b: 'a',\n        agent: agent\n      };\n      http.get(opts);\n    });\n  });\n  describe('`this` context', function() {\n    it('should be the Agent instance', function(done) {\n      var called = false;\n      var agent = new Agent();\n      agent.callback = function() {\n        called = true;\n        assert.equal(this, agent);\n      };\n      var info = url.parse('http://127.0.0.1/foo');\n      info.agent = agent;\n      var req = http.get(info);\n      req.on('error', function(err) {\n        assert(/no Duplex stream was returned/.test(err.message));\n        done();\n      });\n    });\n    it('should be the Agent instance with callback signature', function(done) {\n      var called = false;\n      var agent = new Agent();\n      agent.callback = function(req, opts, fn) {\n        called = true;\n        assert.equal(this, agent);\n        fn();\n      };\n      var info = url.parse('http://127.0.0.1/foo');\n      info.agent = agent;\n      var req = http.get(info);\n      req.on('error', function(err) {\n        assert(/no Duplex stream was returned/.test(err.message));\n        done();\n      });\n    });\n  });\n  describe('\"error\" event', function() {\n    it('should be invoked on `http.ClientRequest` instance if `callback()` has not been defined', function(\n      done\n    ) {\n      var agent = new Agent();\n      var info = url.parse('http://127.0.0.1/foo');\n      info.agent = agent;\n      var req = http.get(info);\n      req.on('error', function(err) {\n        assert.equal(\n          '\"agent-base\" has no default implementation, you must subclass and override `callback()`',\n          err.message\n        );\n        done();\n      });\n    });\n    it('should be invoked on `http.ClientRequest` instance if Error passed to callback function on the first tick', function(\n      done\n    ) {\n      var agent = new Agent(function(req, opts, fn) {\n        fn(new Error('is this caught?'));\n      });\n      var info = url.parse('http://127.0.0.1/foo');\n      info.agent = agent;\n      var req = http.get(info);\n      req.on('error', function(err) {\n        assert.equal('is this caught?', err.message);\n        done();\n      });\n    });\n    it('should be invoked on `http.ClientRequest` instance if Error passed to callback function after the first tick', function(\n      done\n    ) {\n      var agent = new Agent(function(req, opts, fn) {\n        setTimeout(function() {\n          fn(new Error('is this caught?'));\n        }, 10);\n      });\n      var info = url.parse('http://127.0.0.1/foo');\n      info.agent = agent;\n      var req = http.get(info);\n      req.on('error', function(err) {\n        assert.equal('is this caught?', err.message);\n        done();\n      });\n    });\n  });\n  describe('artificial \"streams\"', function() {\n    it('should send a GET request', function(done) {\n      var stream = new events.EventEmitter();\n\n      // needed for the `http` module to call .write() on the stream\n      stream.writable = true;\n\n      stream.write = function(str) {\n        assert(0 == str.indexOf('GET / HTTP/1.1'));\n        done();\n      };\n\n      // needed for `http` module in Node.js 4\n      stream.cork = function() {};\n\n      var opts = {\n        method: 'GET',\n        host: '127.0.0.1',\n        path: '/',\n        port: 80,\n        agent: new Agent(function(req, opts, fn) {\n          fn(null, stream);\n        })\n      };\n      var req = http.request(opts);\n      req.end();\n    });\n    it('should receive a GET response', function(done) {\n      var stream = new events.EventEmitter();\n      var opts = {\n        method: 'GET',\n        host: '127.0.0.1',\n        path: '/',\n        port: 80,\n        agent: new Agent(function(req, opts, fn) {\n          fn(null, stream);\n        })\n      };\n      var req = http.request(opts, function(res) {\n        assert.equal('0.9', res.httpVersion);\n        assert.equal(111, res.statusCode);\n        assert.equal('bar', res.headers.foo);\n        done();\n      });\n\n      // have to wait for the \"socket\" event since `http.ClientRequest`\n      // doesn't *actually* attach the listeners to the \"stream\" until\n      // this happens\n      req.once('socket', function() {\n        var buf = new Buffer(\n          'HTTP/0.9 111\\r\\n' +\n            'Foo: bar\\r\\n' +\n            'Set-Cookie: 1\\r\\n' +\n            'Set-Cookie: 2\\r\\n\\r\\n'\n        );\n        stream.emit('data', buf);\n      });\n\n      req.end();\n    });\n  });\n});\n\ndescribe('\"http\" module', function() {\n  var server;\n  var port;\n\n  // setup test HTTP server\n  before(function(done) {\n    server = http.createServer();\n    server.listen(0, function() {\n      port = server.address().port;\n      done();\n    });\n  });\n\n  // shut down test HTTP server\n  after(function(done) {\n    server.once('close', function() {\n      done();\n    });\n    server.close();\n  });\n\n  it('should work for basic HTTP requests', function(done) {\n    var called = false;\n    var agent = new Agent(function(req, opts, fn) {\n      called = true;\n      var socket = net.connect(opts);\n      fn(null, socket);\n    });\n\n    // add HTTP server \"request\" listener\n    var gotReq = false;\n    server.once('request', function(req, res) {\n      gotReq = true;\n      res.setHeader('X-Foo', 'bar');\n      res.setHeader('X-Url', req.url);\n      res.end();\n    });\n\n    var info = url.parse('http://127.0.0.1:' + port + '/foo');\n    info.agent = agent;\n    http.get(info, function(res) {\n      assert.equal('bar', res.headers['x-foo']);\n      assert.equal('/foo', res.headers['x-url']);\n      assert(gotReq);\n      assert(called);\n      done();\n    });\n  });\n\n  it('should support direct return in `connect()`', function(done) {\n    var called = false;\n    var agent = new Agent(function(req, opts) {\n      called = true;\n      return net.connect(opts);\n    });\n\n    // add HTTP server \"request\" listener\n    var gotReq = false;\n    server.once('request', function(req, res) {\n      gotReq = true;\n      res.setHeader('X-Foo', 'bar');\n      res.setHeader('X-Url', req.url);\n      res.end();\n    });\n\n    var info = url.parse('http://127.0.0.1:' + port + '/foo');\n    info.agent = agent;\n    http.get(info, function(res) {\n      assert.equal('bar', res.headers['x-foo']);\n      assert.equal('/foo', res.headers['x-url']);\n      assert(gotReq);\n      assert(called);\n      done();\n    });\n  });\n\n  it('should support returning a Promise in `connect()`', function(done) {\n    var called = false;\n    var agent = new Agent(function(req, opts) {\n      return new Promise(function(resolve, reject) {\n        called = true;\n        resolve(net.connect(opts));\n      });\n    });\n\n    // add HTTP server \"request\" listener\n    var gotReq = false;\n    server.once('request', function(req, res) {\n      gotReq = true;\n      res.setHeader('X-Foo', 'bar');\n      res.setHeader('X-Url', req.url);\n      res.end();\n    });\n\n    var info = url.parse('http://127.0.0.1:' + port + '/foo');\n    info.agent = agent;\n    http.get(info, function(res) {\n      assert.equal('bar', res.headers['x-foo']);\n      assert.equal('/foo', res.headers['x-url']);\n      assert(gotReq);\n      assert(called);\n      done();\n    });\n  });\n\n  it('should set the `Connection: close` response header', function(done) {\n    var called = false;\n    var agent = new Agent(function(req, opts, fn) {\n      called = true;\n      var socket = net.connect(opts);\n      fn(null, socket);\n    });\n\n    // add HTTP server \"request\" listener\n    var gotReq = false;\n    server.once('request', function(req, res) {\n      gotReq = true;\n      res.setHeader('X-Url', req.url);\n      assert.equal('close', req.headers.connection);\n      res.end();\n    });\n\n    var info = url.parse('http://127.0.0.1:' + port + '/bar');\n    info.agent = agent;\n    http.get(info, function(res) {\n      assert.equal('/bar', res.headers['x-url']);\n      assert.equal('close', res.headers.connection);\n      assert(gotReq);\n      assert(called);\n      done();\n    });\n  });\n\n  it('should pass through options from `http.request()`', function(done) {\n    var agent = new Agent(function(req, opts, fn) {\n      assert.equal('google.com', opts.host);\n      assert.equal('bar', opts.foo);\n      done();\n    });\n\n    http.get({\n      host: 'google.com',\n      foo: 'bar',\n      agent: agent\n    });\n  });\n\n  it('should default to port 80', function(done) {\n    var agent = new Agent(function(req, opts, fn) {\n      assert.equal(80, opts.port);\n      done();\n    });\n\n    // (probably) not hitting a real HTTP server here,\n    // so no need to add a httpServer request listener\n    http.get({\n      host: '127.0.0.1',\n      path: '/foo',\n      agent: agent\n    });\n  });\n\n  it('should support the \"timeout\" option', function(done) {\n    // ensure we timeout after the \"error\" event had a chance to trigger\n    this.timeout(1000);\n    this.slow(800);\n\n    var agent = new Agent(\n      function(req, opts, fn) {\n        // this function will time out\n      },\n      { timeout: 100 }\n    );\n\n    var opts = url.parse('http://nodejs.org');\n    opts.agent = agent;\n\n    var req = http.get(opts);\n    req.once('error', function(err) {\n      assert.equal('ETIMEOUT', err.code);\n      req.abort();\n      done();\n    });\n  });\n\n  it('should free sockets after use', function(done) {\n    var agent = new Agent(function(req, opts, fn) {\n      var socket = net.connect(opts);\n      fn(null, socket);\n    });\n\n    // add HTTP server \"request\" listener\n    var gotReq = false;\n    server.once('request', function(req, res) {\n      gotReq = true;\n      res.end();\n    });\n\n    var info = url.parse('http://127.0.0.1:' + port + '/foo');\n    info.agent = agent;\n    http.get(info, function(res) {\n      res.socket.emit('free');\n      assert.equal(true, res.socket.destroyed);\n      assert(gotReq);\n      done();\n    });\n  });\n\n\n  describe('PassthroughAgent', function() {\n    it('should pass through to `http.globalAgent`', function(done) {\n      // add HTTP server \"request\" listener\n      var gotReq = false;\n      server.once('request', function(req, res) {\n        gotReq = true;\n        res.setHeader('X-Foo', 'bar');\n        res.setHeader('X-Url', req.url);\n        res.end();\n      });\n\n      var info = url.parse('http://127.0.0.1:' + port + '/foo');\n      info.agent = PassthroughAgent;\n      http.get(info, function(res) {\n        assert.equal('bar', res.headers['x-foo']);\n        assert.equal('/foo', res.headers['x-url']);\n        assert(gotReq);\n        done();\n      });\n    });\n  });\n});\n\ndescribe('\"https\" module', function() {\n  var server;\n  var port;\n\n  // setup test HTTPS server\n  before(function(done) {\n    var options = {\n      key: fs.readFileSync(__dirname + '/ssl-cert-snakeoil.key'),\n      cert: fs.readFileSync(__dirname + '/ssl-cert-snakeoil.pem')\n    };\n    server = https.createServer(options);\n    server.listen(0, function() {\n      port = server.address().port;\n      done();\n    });\n  });\n\n  // shut down test HTTP server\n  after(function(done) {\n    server.once('close', function() {\n      done();\n    });\n    server.close();\n  });\n\n  it('should not modify the passed in Options object', function(done) {\n    var called = false;\n    var agent = new Agent(function(req, opts, fn) {\n      called = true;\n      assert.equal(true, opts.secureEndpoint);\n      assert.equal(443, opts.port);\n      assert.equal('localhost', opts.host);\n    });\n    var opts = { agent: agent };\n    var req = https.request(opts);\n    assert.equal(true, called);\n    assert.equal(false, 'secureEndpoint' in opts);\n    assert.equal(false, 'port' in opts);\n    done();\n  });\n\n  it('should work with a String URL', function(done) {\n    var endpoint = 'https://127.0.0.1:' + port;\n    var req = https.get(endpoint);\n\n    // it's gonna error out since `rejectUnauthorized` is not being passed in\n    req.on('error', function(err) {\n      assert.equal(err.code, 'DEPTH_ZERO_SELF_SIGNED_CERT');\n      done();\n    });\n  });\n\n  it('should work for basic HTTPS requests', function(done) {\n    var called = false;\n    var agent = new Agent(function(req, opts, fn) {\n      called = true;\n      assert(opts.secureEndpoint);\n      var socket = tls.connect(opts);\n      fn(null, socket);\n    });\n\n    // add HTTPS server \"request\" listener\n    var gotReq = false;\n    server.once('request', function(req, res) {\n      gotReq = true;\n      res.setHeader('X-Foo', 'bar');\n      res.setHeader('X-Url', req.url);\n      res.end();\n    });\n\n    var info = url.parse('https://127.0.0.1:' + port + '/foo');\n    info.agent = agent;\n    info.rejectUnauthorized = false;\n    https.get(info, function(res) {\n      assert.equal('bar', res.headers['x-foo']);\n      assert.equal('/foo', res.headers['x-url']);\n      assert(gotReq);\n      assert(called);\n      done();\n    });\n  });\n\n  it('should pass through options from `https.request()`', function(done) {\n    var agent = new Agent(function(req, opts, fn) {\n      assert.equal('google.com', opts.host);\n      assert.equal('bar', opts.foo);\n      done();\n    });\n\n    https.get({\n      host: 'google.com',\n      foo: 'bar',\n      agent: agent\n    });\n  });\n\n  it('should default to port 443', function(done) {\n    var agent = new Agent(function(req, opts, fn) {\n      assert.equal(true, opts.secureEndpoint);\n      assert.equal(false, opts.rejectUnauthorized);\n      assert.equal(443, opts.port);\n      done();\n    });\n\n    // (probably) not hitting a real HTTPS server here,\n    // so no need to add a httpsServer request listener\n    https.get({\n      host: '127.0.0.1',\n      path: '/foo',\n      agent: agent,\n      rejectUnauthorized: false\n    });\n  });\n\n  describe('PassthroughAgent', function() {\n    it('should pass through to `https.globalAgent`', function(done) {\n      // add HTTP server \"request\" listener\n      var gotReq = false;\n      server.once('request', function(req, res) {\n        gotReq = true;\n        res.setHeader('X-Foo', 'bar');\n        res.setHeader('X-Url', req.url);\n        res.end();\n      });\n\n      var info = url.parse('https://127.0.0.1:' + port + '/foo');\n      info.agent = PassthroughAgent;\n      info.rejectUnauthorized = false;\n      https.get(info, function(res) {\n        assert.equal('bar', res.headers['x-foo']);\n        assert.equal('/foo', res.headers['x-url']);\n        assert(gotReq);\n        done();\n      });\n    });\n  });\n});\n\ndescribe('\"ws\" server', function() {\n  var wss;\n  var server;\n  var port;\n\n  // setup test HTTP server\n  before(function(done) {\n    server = http.createServer();\n    wss = new WebSocket.Server({ server: server });\n    server.listen(0, function() {\n      port = server.address().port;\n      done();\n    });\n  });\n\n  // shut down test HTTP server\n  after(function(done) {\n    server.once('close', function() {\n      done();\n    });\n    server.close();\n  });\n\n  it('should work for basic WebSocket connections', function(done) {\n    function onconnection(ws) {\n      ws.on('message', function(data) {\n        assert.equal('ping', data);\n        ws.send('pong');\n      });\n    }\n    wss.on('connection', onconnection);\n\n    var agent = new Agent(function(req, opts, fn) {\n      var socket = net.connect(opts);\n      fn(null, socket);\n    });\n\n    var client = new WebSocket('ws://127.0.0.1:' + port + '/', {\n      agent: agent\n    });\n\n    client.on('open', function() {\n      client.send('ping');\n    });\n\n    client.on('message', function(data) {\n      assert.equal('pong', data);\n      client.close();\n      wss.removeListener('connection', onconnection);\n      done();\n    });\n  });\n});\n\ndescribe('\"wss\" server', function() {\n  var wss;\n  var server;\n  var port;\n\n  // setup test HTTP server\n  before(function(done) {\n    var options = {\n      key: fs.readFileSync(__dirname + '/ssl-cert-snakeoil.key'),\n      cert: fs.readFileSync(__dirname + '/ssl-cert-snakeoil.pem')\n    };\n    server = https.createServer(options);\n    wss = new WebSocket.Server({ server: server });\n    server.listen(0, function() {\n      port = server.address().port;\n      done();\n    });\n  });\n\n  // shut down test HTTP server\n  after(function(done) {\n    server.once('close', function() {\n      done();\n    });\n    server.close();\n  });\n\n  it('should work for secure WebSocket connections', function(done) {\n    function onconnection(ws) {\n      ws.on('message', function(data) {\n        assert.equal('ping', data);\n        ws.send('pong');\n      });\n    }\n    wss.on('connection', onconnection);\n\n    var agent = new Agent(function(req, opts, fn) {\n      var socket = tls.connect(opts);\n      fn(null, socket);\n    });\n\n    var client = new WebSocket('wss://127.0.0.1:' + port + '/', {\n      agent: agent,\n      rejectUnauthorized: false\n    });\n\n    client.on('open', function() {\n      client.send('ping');\n    });\n\n    client.on('message', function(data) {\n      assert.equal('pong', data);\n      client.close();\n      wss.removeListener('connection', onconnection);\n      done();\n    });\n  });\n});\n"]}