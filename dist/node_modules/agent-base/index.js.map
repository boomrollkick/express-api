{"version":3,"sources":["../../../src/node_modules/agent-base/index.js"],"names":["require","inherits","promisify","EventEmitter","module","exports","Agent","isAgent","v","addRequest","callback","_opts","call","_promisifiedCallback","opts","timeout","options","prototype","req","Error","ownOpts","Object","assign","host","port","secureEndpoint","path","agent","hostname","_defaultAgent","defaultPort","createConnection","_last","shouldKeepAlive","timedOut","timeoutMs","freeSocket","onerror","err","_hadError","emit","ontimeout","code","callbackError","clearTimeout","onsocket","socket","onfree","on","onSocket","method","length","setTimeout","Promise","resolve","then","reject","catch","destroy"],"mappings":"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","file":"index.js","sourcesContent":["'use strict';\nrequire('./patch-core');\nconst inherits = require('util').inherits;\nconst promisify = require('es6-promisify');\nconst EventEmitter = require('events').EventEmitter;\n\nmodule.exports = Agent;\n\nfunction isAgent(v) {\n  return v && typeof v.addRequest === 'function';\n}\n\n/**\n * Base `http.Agent` implementation.\n * No pooling/keep-alive is implemented by default.\n *\n * @param {Function} callback\n * @api public\n */\nfunction Agent(callback, _opts) {\n  if (!(this instanceof Agent)) {\n    return new Agent(callback, _opts);\n  }\n\n  EventEmitter.call(this);\n\n  // The callback gets promisified if it has 3 parameters\n  // (i.e. it has a callback function) lazily\n  this._promisifiedCallback = false;\n\n  let opts = _opts;\n  if ('function' === typeof callback) {\n    this.callback = callback;\n  } else if (callback) {\n    opts = callback;\n  }\n\n  // timeout for the socket to be returned from the callback\n  this.timeout = (opts && opts.timeout) || null;\n\n  this.options = opts;\n}\ninherits(Agent, EventEmitter);\n\n/**\n * Override this function in your subclass!\n */\nAgent.prototype.callback = function callback(req, opts) {\n  throw new Error(\n    '\"agent-base\" has no default implementation, you must subclass and override `callback()`'\n  );\n};\n\n/**\n * Called by node-core's \"_http_client.js\" module when creating\n * a new HTTP request with this Agent instance.\n *\n * @api public\n */\nAgent.prototype.addRequest = function addRequest(req, _opts) {\n  const ownOpts = Object.assign({}, _opts);\n\n  // Set default `host` for HTTP to localhost\n  if (null == ownOpts.host) {\n    ownOpts.host = 'localhost';\n  }\n\n  // Set default `port` for HTTP if none was explicitly specified\n  if (null == ownOpts.port) {\n    ownOpts.port = ownOpts.secureEndpoint ? 443 : 80;\n  }\n\n  const opts = Object.assign({}, this.options, ownOpts);\n\n  if (opts.host && opts.path) {\n    // If both a `host` and `path` are specified then it's most likely the\n    // result of a `url.parse()` call... we need to remove the `path` portion so\n    // that `net.connect()` doesn't attempt to open that as a unix socket file.\n    delete opts.path;\n  }\n\n  delete opts.agent;\n  delete opts.hostname;\n  delete opts._defaultAgent;\n  delete opts.defaultPort;\n  delete opts.createConnection;\n\n  // Hint to use \"Connection: close\"\n  // XXX: non-documented `http` module API :(\n  req._last = true;\n  req.shouldKeepAlive = false;\n\n  // Create the `stream.Duplex` instance\n  let timeout;\n  let timedOut = false;\n  const timeoutMs = this.timeout;\n  const freeSocket = this.freeSocket;\n\n  function onerror(err) {\n    if (req._hadError) return;\n    req.emit('error', err);\n    // For Safety. Some additional errors might fire later on\n    // and we need to make sure we don't double-fire the error event.\n    req._hadError = true;\n  }\n\n  function ontimeout() {\n    timeout = null;\n    timedOut = true;\n    const err = new Error(\n      'A \"socket\" was not created for HTTP request before ' + timeoutMs + 'ms'\n    );\n    err.code = 'ETIMEOUT';\n    onerror(err);\n  }\n\n  function callbackError(err) {\n    if (timedOut) return;\n    if (timeout != null) {\n      clearTimeout(timeout);\n      timeout = null;\n    }\n    onerror(err);\n  }\n\n  function onsocket(socket) {\n    if (timedOut) return;\n    if (timeout != null) {\n      clearTimeout(timeout);\n      timeout = null;\n    }\n    if (isAgent(socket)) {\n      // `socket` is actually an http.Agent instance, so relinquish\n      // responsibility for this `req` to the Agent from here on\n      socket.addRequest(req, opts);\n    } else if (socket) {\n      function onfree() {\n        freeSocket(socket, opts);\n      }\n      socket.on('free', onfree);\n      req.onSocket(socket);\n    } else {\n      const err = new Error(\n        'no Duplex stream was returned to agent-base for `' + req.method + ' ' + req.path + '`'\n      );\n      onerror(err);\n    }\n  }\n\n  if (!this._promisifiedCallback && this.callback.length >= 3) {\n    // Legacy callback function - convert to a Promise\n    this.callback = promisify(this.callback, this);\n    this._promisifiedCallback = true;\n  }\n\n  if (timeoutMs > 0) {\n    timeout = setTimeout(ontimeout, timeoutMs);\n  }\n\n  try {\n    Promise.resolve(this.callback(req, opts)).then(onsocket, callbackError);\n  } catch (err) {\n    Promise.reject(err).catch(callbackError);\n  }\n};\n\nAgent.prototype.freeSocket = function freeSocket(socket, opts) {\n  // TODO reuse sockets\n  socket.destroy();\n};\n"]}